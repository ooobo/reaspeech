name: Build Parakeet Transcribe Executable

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'python/parakeet_transcribe.py'
      - 'python/parakeet_transcribe.spec'
      - '.github/workflows/build-executable.yml'
  pull_request:
    paths:
      - 'python/parakeet_transcribe.py'
      - 'python/parakeet_transcribe.spec'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install FFmpeg
      run: |
        choco install ffmpeg -y
        ffmpeg -version

    - name: Install dependencies
      working-directory: python
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install onnx-asr onnxruntime numpy ffmpeg-python huggingface-hub

    - name: Build executable
      working-directory: python
      run: |
        pyinstaller parakeet_transcribe.spec

    - name: Verify executable
      working-directory: python
      run: |
        dir dist
        if (Test-Path "dist/parakeet-transcribe-windows.exe") {
          Write-Host "✓ Executable built successfully"
          $size = (Get-Item "dist/parakeet-transcribe-windows.exe").Length / 1MB
          Write-Host "Executable size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Error "✗ Executable not found!"
          exit 1
        }

    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: parakeet-transcribe-windows
        path: python/dist/parakeet-transcribe-windows.exe
        retention-days: 90

    - name: Test executable (basic check)
      working-directory: python
      run: |
        # Just check if it runs without error on --help
        dist/parakeet-transcribe-windows.exe --help

    - name: Cache FFmpeg for Windows
      id: cache-ffmpeg-windows
      uses: actions/cache@v4
      with:
        path: ffmpeg-cache-windows
        key: ffmpeg-windows-essentials-v1

    - name: Download FFmpeg for Windows
      if: steps.cache-ffmpeg-windows.outputs.cache-hit != 'true'
      run: |
        # Download FFmpeg from gyan.dev (essentials build)
        $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
        Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg.zip
        Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg-temp

        # Find and copy ffmpeg.exe (it's in bin subdirectory)
        $ffmpegExe = Get-ChildItem -Path ffmpeg-temp -Recurse -Filter ffmpeg.exe | Select-Object -First 1
        if ($ffmpegExe) {
          # Cache it for future runs
          New-Item -ItemType Directory -Path ffmpeg-cache-windows -Force
          Copy-Item $ffmpegExe.FullName -Destination ffmpeg-cache-windows/ffmpeg.exe
          Write-Host "✓ FFmpeg downloaded and cached"
        } else {
          Write-Error "✗ FFmpeg executable not found in download!"
          exit 1
        }

    - name: Copy FFmpeg from cache
      run: |
        Copy-Item -Path ffmpeg-cache-windows/ffmpeg.exe -Destination python/dist/
        Write-Host "✓ FFmpeg copied to dist folder"

    - name: Create deployment package
      run: |
        # Build the production ReaSpeech scripts
        cd reascripts/ReaSpeech

        # Build the bundle (concatenate all source files - no compilation needed)
        # Concatenate all source files
        $bundleContent = @(
          "source/include/header.lua",
          "source/include/globals.lua",
          "vendor/json.lua",
          "vendor/url.lua"
        )
        $bundleContent += Get-ChildItem -Path "resources/images" -Filter "*.lua" | ForEach-Object { $_.FullName }
        $bundleContent += Get-ChildItem -Path "source/libs" -Filter "*.lua" -Recurse | ForEach-Object { $_.FullName }
        $bundleContent += Get-ChildItem -Path "source/ui" -Filter "*.lua" -Recurse | ForEach-Object { $_.FullName }
        $bundleContent += Get-ChildItem -Path "source/main" -Filter "*.lua" -Recurse | ForEach-Object { $_.FullName }
        $bundleContent += "version.lua"
        $bundleContent += "source/include/main.lua"

        # Create build directory
        New-Item -ItemType Directory -Path build -Force | Out-Null

        # Concatenate all files
        Get-Content $bundleContent | Set-Content -Path "build/ReaSpeechBundle.lua" -Encoding UTF8

        Write-Host "Created bundle: build/ReaSpeechBundle.lua"

        # Add Script global configuration and save as ReaSpeech.lua
        # (REAPER loads .lua files, not .luac bytecode)
        "-- @description ReaSpeech - Speech recognition for REAPER" | Set-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "-- @version 0.7.1-fork1" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "-- @author ReaSpeech Contributors" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "-- @about" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "--   # ReaSpeech" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "--   Speech recognition tool for REAPER using Parakeet ASR" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "-- ReaSpeech production configuration" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "Script = {" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        '  name = "ReaSpeech",' | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "  executable_path = nil," | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        '  env = "production",' | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "  lua = _VERSION:match('[%d.]+')," | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "  timeout = 30000," | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "}" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        "" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8
        Get-Content "build/ReaSpeechBundle.lua" | Add-Content -Path "build/ReaSpeech.lua" -Encoding UTF8

        Write-Host "✓ Built ReaSpeech.lua"

        cd ../..

        # Create package directory (flat structure for direct extraction to Scripts/)
        New-Item -ItemType Directory -Path package -Force

        # Copy ReaSpeech.lua to package root
        Copy-Item -Path reascripts/ReaSpeech/build/ReaSpeech.lua -Destination package/

        # Copy resources folder
        Copy-Item -Path reascripts/ReaSpeech/resources -Destination package/ -Recurse

        # Copy executables to package root
        Copy-Item -Path python/dist/parakeet-transcribe-windows.exe -Destination package/
        Copy-Item -Path python/dist/ffmpeg.exe -Destination package/

        # Create README
        @"
        # ReaSpeech Windows Package

        ## Installation

        1. Extract this package directly to your REAPER Scripts directory:
           %AppData%\Roaming\REAPER\Scripts\Reaspeech

           After extraction, you should have in that ReaSpeech folder:
           - ReaSpeech.lua (the main script)
           - resources/ (UI resources)
           - parakeet-transcribe-windows.exe (transcription engine)
           - ffmpeg.exe (audio processing)

        2. In REAPER, go to Actions > Show action list > New Action... > Load ReaScript
           and load ReaSpeech.lua from that scripts folder.

        ## Usage

        After loading the script in REAPER, access ReaSpeech from the Actions menu.
        The parakeet-transcribe executable will be called automatically.

        ## Requirements

        - REAPER 6.0 or later with ReaImGui extension (v0.9+)
        - Windows 10 or later

        ## Note

        Works with both REAPER 6.x (Lua 5.3) and REAPER 7.x (Lua 5.4).
        "@ | Out-File -FilePath package/ReaSpeech-Readme.txt -Encoding UTF8

        Write-Host "✓ Package created"
        Get-ChildItem package | Select-Object Name, @{Name="Size (MB)";Expression={[math]::Round($_.Length / 1MB, 2)}}

    - name: Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: reaspeech-windows-package
        path: package/
        retention-days: 90

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install FFmpeg
      run: |
        brew install ffmpeg
        ffmpeg -version

    - name: Install dependencies
      working-directory: python
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install onnx-asr onnxruntime numpy ffmpeg-python huggingface-hub

    - name: Build executable
      working-directory: python
      run: |
        pyinstaller parakeet_transcribe.spec

    - name: Verify executable
      working-directory: python
      run: |
        ls -lh dist/
        if [ -f "dist/parakeet-transcribe-macos" ]; then
          echo "✓ Executable built successfully"
          size=$(du -h dist/parakeet-transcribe-macos | cut -f1)
          echo "Executable size: $size"
        else
          echo "✗ Executable not found!"
          exit 1
        fi

    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: parakeet-transcribe-macos
        path: python/dist/parakeet-transcribe-macos
        retention-days: 90

    - name: Test executable (basic check)
      working-directory: python
      run: |
        # Just check if it runs without error on --help
        chmod +x dist/parakeet-transcribe-macos
        dist/parakeet-transcribe-macos --help

    - name: Cache FFmpeg for macOS
      id: cache-ffmpeg-macos
      uses: actions/cache@v4
      with:
        path: ffmpeg-cache-macos
        key: ffmpeg-macos-7.1-v1

    - name: Download FFmpeg for macOS
      if: steps.cache-ffmpeg-macos.outputs.cache-hit != 'true'
      run: |
        # Download FFmpeg from evermeet.cx
        curl -L -o ffmpeg.7z https://evermeet.cx/ffmpeg/ffmpeg-7.1.7z

        # Install 7z if not available
        brew install p7zip

        # Extract ffmpeg
        7z x ffmpeg.7z -o./

        # Cache it for future runs
        mkdir -p ffmpeg-cache-macos
        cp ffmpeg ffmpeg-cache-macos/
        chmod +x ffmpeg-cache-macos/ffmpeg

        echo "✓ FFmpeg downloaded and cached"

    - name: Copy FFmpeg from cache
      run: |
        cp ffmpeg-cache-macos/ffmpeg python/dist/
        chmod +x python/dist/ffmpeg
        echo "✓ FFmpeg copied to dist folder"
        ls -lh python/dist/ffmpeg

    - name: Create deployment package
      run: |
        # Build the production ReaSpeech scripts
        cd reascripts/ReaSpeech

        # Build the bundle (concatenate all source files - no compilation needed)
        mkdir -p build

        # Concatenate all source files in correct order
        cat \
          source/include/header.lua \
          source/include/globals.lua \
          vendor/json.lua \
          vendor/url.lua \
          resources/images/*.lua \
          source/libs/*.lua \
          source/ui/*.lua \
          source/ui/widgets/*.lua \
          source/main/*.lua \
          version.lua \
          source/include/main.lua \
          > build/ReaSpeechBundle.lua

        echo "✓ Created bundle: build/ReaSpeechBundle.lua"

        # Add Script global configuration and save as ReaSpeech.lua
        # (REAPER loads .lua files, not .luac bytecode)
        echo "-- @description ReaSpeech - Speech recognition for REAPER" > build/ReaSpeech.lua
        echo "-- @version 0.7.1-fork1" >> build/ReaSpeech.lua
        echo "-- @author ReaSpeech Contributors" >> build/ReaSpeech.lua
        echo "-- @about" >> build/ReaSpeech.lua
        echo "--   # ReaSpeech" >> build/ReaSpeech.lua
        echo "--   Speech recognition tool for REAPER using Parakeet ASR" >> build/ReaSpeech.lua
        echo "" >> build/ReaSpeech.lua
        echo "-- ReaSpeech production configuration" >> build/ReaSpeech.lua
        echo "Script = {" >> build/ReaSpeech.lua
        echo '  name = "ReaSpeech",' >> build/ReaSpeech.lua
        echo "  executable_path = nil," >> build/ReaSpeech.lua
        echo '  env = "production",' >> build/ReaSpeech.lua
        echo "  lua = _VERSION:match('[%d.]+')," >> build/ReaSpeech.lua
        echo "  timeout = 30000," >> build/ReaSpeech.lua
        echo "}" >> build/ReaSpeech.lua
        echo "" >> build/ReaSpeech.lua
        cat build/ReaSpeechBundle.lua >> build/ReaSpeech.lua

        echo "✓ Built ReaSpeech.lua"

        cd ../..

        # Create package directory (flat structure for direct extraction to Scripts/)
        mkdir -p package

        # Copy ReaSpeech.lua to package root
        cp reascripts/ReaSpeech/build/ReaSpeech.lua package/

        # Copy resources folder
        cp -r reascripts/ReaSpeech/resources package/

        # Copy executables to package root
        cp python/dist/parakeet-transcribe-macos package/
        cp python/dist/ffmpeg package/

        # Make executables executable
        chmod +x package/parakeet-transcribe-macos
        chmod +x package/ffmpeg

        # Create README
        echo "# ReaSpeech macOS Package" > package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "## Installation" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "1. Extract this package directly to your REAPER Scripts directory:" >> package/ReaSpeech-Readme.txt
        echo "   ~/Library/Application Support/REAPER/Scripts/" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "   After extraction, you should have:" >> package/ReaSpeech-Readme.txt
        echo "   - ReaSpeech.lua (the main script)" >> package/ReaSpeech-Readme.txt
        echo "   - resources/ (UI resources)" >> package/ReaSpeech-Readme.txt
        echo "   - parakeet-transcribe-macos (transcription engine)" >> package/ReaSpeech-Readme.txt
        echo "   - ffmpeg (audio processing)" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "2. In REAPER, go to Actions > Show action list > New Action... > Load ReaScript" >> package/ReaSpeech-Readme.txt
        echo "   and load ReaSpeech.lua from that scripts folder." >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "## First Run - Security Note" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "On first run, macOS Gatekeeper may block the executable." >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "FIX: Allow in System Settings" >> package/ReaSpeech-Readme.txt
        echo "- When blocked, go to System Settings > Privacy & Security" >> package/ReaSpeech-Readme.txt
        echo "- Click \"Open Anyway\" for each blocked executable" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "## Usage" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "After loading the script in REAPER, access ReaSpeech from the Actions menu." >> package/ReaSpeech-Readme.txt
        echo "The parakeet-transcribe executable will be called automatically." >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "## Requirements" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "- REAPER 6.0 or later with ReaImGui extension (v0.9+)" >> package/ReaSpeech-Readme.txt
        echo "- macOS 10.15 (Catalina) or later" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "## Note" >> package/ReaSpeech-Readme.txt
        echo "" >> package/ReaSpeech-Readme.txt
        echo "Works with both REAPER 6.x (Lua 5.3) and REAPER 7.x (Lua 5.4)." >> package/ReaSpeech-Readme.txt

        echo "✓ Package created"
        ls -lh package/

    - name: Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: reaspeech-macos-package
        path: package/
        retention-days: 90
